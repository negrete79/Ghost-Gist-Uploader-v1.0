<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost Gist Uploader v1.0</title>
    
    <!-- Meta tags para PWA -->
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ghost Gist">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Manifesto da PWA -->
    <link rel="manifest" href="manifest.json">
    
    <!-- √çcones para PWA -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512x512.png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Source+Code+Pro:wght@400;600&display=swap');
        
        :root {
            --primary-color: #0ff;
            --secondary-color: #f0f;
            --success-color: #0f0;
            --danger-color: #f00;
            --warning-color: #ff0;
            --dark-bg: #0a0a0a;
            --card-bg: rgba(26, 26, 46, 0.8);
        }
        
        body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1a1a2e 100%);
            color: #fff;
            font-family: 'Source Code Pro', monospace;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .banner {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(22, 33, 62, 0.8) 100%);
            border-radius: 15px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .banner::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 255, 255, 0.1) 0%, transparent 70%);
            animation: pulse 8s infinite linear;
        }
        
        @keyframes pulse {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .banner h1 {
            font-family: 'Orbitron', monospace;
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--primary-color);
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.7);
            margin-bottom: 10px;
            letter-spacing: 3px;
            position: relative;
            z-index: 1;
        }
        
        .banner p {
            color: #aaa;
            font-size: 1rem;
            position: relative;
            z-index: 1;
        }
        
        .menu-card {
            background: var(--card-bg);
            border: 2px solid var(--primary-color);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.3);
        }
        
        .menu-card h2 {
            color: var(--primary-color);
            font-family: 'Orbitron', monospace;
            margin-bottom: 20px;
            text-transform: uppercase;
        }
        
        .menu-btn {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(22, 33, 62, 0.8) 100%);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            padding: 12px 25px;
            margin: 10px;
            border-radius: 50px;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(5px);
        }
        
        .menu-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }
        
        .menu-btn:hover::before {
            left: 100%;
        }
        
        .menu-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            transform: translateY(-3px);
        }
        
        .token-input {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            color: #fff;
            padding: 12px;
            width: 100%;
            margin-bottom: 15px;
            font-family: 'Source Code Pro', monospace;
        }
        
        .token-input:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        .file-upload-area {
            border: 2px dashed var(--primary-color);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0, 255, 255, 0.05);
            margin-bottom: 20px;
        }
        
        .file-upload-area:hover {
            background: rgba(0, 255, 255, 0.1);
            transform: scale(1.02);
        }
        
        .file-upload-area.dragover {
            background: rgba(0, 255, 255, 0.2);
            border-color: #fff;
            transform: scale(1.05);
        }
        
        .gist-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--primary-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .gist-item:hover {
            background: rgba(0, 255, 255, 0.1);
            transform: translateY(-3px);
        }
        
        .gist-description {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .gist-url {
            font-size: 0.9rem;
            color: #aaa;
            word-break: break-all;
        }
        
        .action-btn {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(22, 33, 62, 0.8) 100%);
            color: #fff;
            border: 1px solid var(--primary-color);
            padding: 8px 15px;
            margin: 5px;
            border-radius: 20px;
            font-family: 'Source Code Pro', monospace;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .action-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .action-btn.download {
            border-color: var(--success-color);
            color: var(--success-color);
        }
        
        .action-btn.delete {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }
        
        .modal-content {
            background: var(--card-bg);
            border: 2px solid var(--primary-color);
            border-radius: 15px;
            color: #fff;
        }
        
        .modal-header {
            border-bottom: 1px solid var(--primary-color);
        }
        
        .modal-footer {
            border-top: 1px solid var(--primary-color);
        }
        
        .btn-close {
            filter: invert(1);
        }
        
        .guide-content {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .guide-content h3 {
            color: var(--primary-color);
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .guide-content ul {
            padding-left: 20px;
        }
        
        .guide-content li {
            margin-bottom: 10px;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            max-width: 400px;
            transform: translateY(100px);
            transition: transform 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .notification.show {
            transform: translateY(0);
        }
        
        .notification.success {
            border-left: 5px solid var(--success-color);
        }
        
        .notification.error {
            border-left: 5px solid var(--danger-color);
        }
        
        .notification.warning {
            border-left: 5px solid var(--warning-color);
        }
        
        .notification i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .notification.success i {
            color: var(--success-color);
        }
        
        .notification.error i {
            color: var(--danger-color);
        }
        
        .notification.warning i {
            color: var(--warning-color);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Banner de instala√ß√£o PWA - VERS√ÉO CORRIGIDA */
        .install-banner {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.95) 0%, rgba(22, 33, 62, 0.95) 100%);
            border: 2px solid var(--primary-color);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            transform: translateY(200%); /* Escondido por padr√£o */
            transition: transform 0.5s ease-in-out;
        }
        
        .install-banner.show {
            transform: translateY(0); /* Vis√≠vel */
        }
        
        .install-banner-text {
            flex-grow: 1;
            margin-right: 15px;
        }
        
        .install-banner h3 {
            margin: 0 0 5px 0;
            color: var(--primary-color);
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
        }
        
        .install-banner p {
            margin: 0;
            font-size: 0.9rem;
            color: #ccc;
        }
        
        .install-btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, #00ffff 100%);
            color: #000;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .install-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }
        
        .install-dismiss {
            background: transparent;
            border: none;
            color: #aaa;
            font-size: 1.8rem;
            cursor: pointer;
            margin-left: 15px;
            transition: color 0.3s ease;
            line-height: 1;
        }
        
        .install-dismiss:hover {
            color: #fff;
        }
        
        /* Ajuste para telas menores */
        @media (max-width: 768px) {
            .install-banner {
                flex-direction: column;
                text-align: center;
                left: 10px;
                right: 10px;
                bottom: 10px;
                padding: 15px;
            }
            
            .install-banner-text {
                margin-right: 0;
                margin-bottom: 15px;
            }

            .install-banner h3 {
                font-size: 1.1rem;
            }

            .install-banner p {
                font-size: 0.8rem;
            }
            
            .install-banner .install-btn,
            .install-banner .install-dismiss {
                display: inline-block;
                vertical-align: middle;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="banner">
            <h1>Ghost Gist Uploader v1.0</h1>
            <p>Upload, Backup e Gerenciamento de Gists</p>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="menu-card">
                    <h2><i class="fas fa-ghost"></i> Menu Principal</h2>
                    <div class="text-center">
                        <button class="menu-btn" id="uploadBtn"><i class="fas fa-upload"></i> Fazer Upload de Arquivo</button>
                        <button class="menu-btn" id="deleteBtn"><i class="fas fa-trash-alt"></i> Excluir um Gist</button>
                        <button class="menu-btn" id="downloadBtn"><i class="fas fa-download"></i> Baixar Gists</button>
                        <button class="menu-btn" id="guideBtn"><i class="fas fa-question-circle"></i> Guia de Funcionalidades</button>
                        <button class="menu-btn" id="installBtn"><i class="fas fa-cog"></i> Como Usar</button>
                        <button class="menu-btn" id="manageTokenBtn"><i class="fas fa-key"></i> Gerenciar Token</button>
                        <!-- NOVO BOT√ÉO DE INSTALA√á√ÉO MANUAL -->
                        <button class="menu-btn hidden" id="installAppBtn"><i class="fas fa-download"></i> Instalar App</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Se√ß√£o de Upload -->
        <div class="row hidden" id="uploadSection">
            <div class="col-md-12">
                <div class="menu-card">
                    <h2><i class="fas fa-upload"></i> Upload de Arquivo</h2>
                    <div class="file-upload-area" id="fileUploadArea">
                        <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                        <p>Arraste seu arquivo aqui ou clique para selecionar</p>
                        <p>Formato: .txt</p>
                        <input type="file" id="fileInput" accept=".txt" style="display: none;">
                    </div>
                    <div id="fileInfo" class="mb-3"></div>
                    <div class="text-center">
                        <button class="menu-btn" id="processUploadBtn"><i class="fas fa-cloud-upload-alt"></i> Enviar para Gist</button>
                        <button class="menu-btn" id="cancelUploadBtn"><i class="fas fa-times"></i> Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Se√ß√£o de Exclus√£o -->
        <div class="row hidden" id="deleteSection">
            <div class="col-md-12">
                <div class="menu-card">
                    <h2><i class="fas fa-trash-alt"></i> Excluir um Gist</h2>
                    <div id="gistsListDelete" class="mb-3">
                        <p class="text-center">Carregando seus Gists...</p>
                    </div>
                    <div class="text-center">
                        <button class="menu-btn" id="refreshDeleteBtn"><i class="fas fa-sync-alt"></i> Atualizar Lista</button>
                        <button class="menu-btn" id="cancelDeleteBtn"><i class="fas fa-times"></i> Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Se√ß√£o de Download -->
        <div class="row hidden" id="downloadSection">
            <div class="col-md-12">
                <div class="menu-card">
                    <h2><i class="fas fa-download"></i> Baixar Gists</h2>
                    <div class="mb-3">
                        <div class="d-flex justify-content-center mb-3">
                            <button class="action-btn download" id="downloadSingleBtn"><i class="fas fa-file-download"></i> Baixar um Gist Espec√≠fico</button>
                            <button class="action-btn download" id="downloadSeparateBtn"><i class="fas fa-folder-download"></i> Baixar Todos (Separados)</button>
                            <button class="action-btn download" id="downloadCombinedBtn"><i class="fas fa-file-archive"></i> Baixar Todos (Combinados)</button>
                        </div>
                    </div>
                    <div id="gistsListDownload" class="mb-3">
                        <p class="text-center">Carregando seus Gists...</p>
                    </div>
                    <div class="text-center">
                        <button class="menu-btn" id="refreshDownloadBtn"><i class="fas fa-sync-alt"></i> Atualizar Lista</button>
                        <button class="menu-btn" id="cancelDownloadBtn"><i class="fas fa-times"></i> Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Banner de instala√ß√£o PWA -->
    <div class="install-banner" id="installBanner">
        <div class="install-banner-text">
            <h3>Instalar Aplicativo</h3>
            <p>Instale este aplicativo em seu dispositivo para acesso r√°pido e offline</p>
        </div>
        <button class="install-btn" id="installPwaBtn">Instalar</button>
        <button class="install-dismiss" id="dismissInstallBtn">&times;</button>
    </div>
    
    <!-- Modal para Token -->
    <div class="modal fade" id="tokenModal" tabindex="-1" aria-labelledby="tokenModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tokenModalLabel">Token de Acesso do GitHub</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Insira seu Personal Access Token do GitHub com permiss√£o 'gist':</p>
                    <input type="password" class="token-input" id="githubToken" placeholder="ghp_...">
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="saveToken" checked>
                        <label class="form-check-label" for="saveToken">
                            Salvar token no navegador
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="action-btn" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="action-btn" id="saveTokenBtn">Salvar Token</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Guia de Funcionalidades -->
    <div class="modal fade" id="guideModal" tabindex="-1" aria-labelledby="guideModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="guideModalLabel">Guia de Funcionalidades: Ghost Gist Uploader</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="guide-content">
                        <p>O <strong>Ghost Gist Uploader</strong> √© uma ferramenta projetada para simplificar a vida de quem precisa gerenciar arquivos de texto (como "combos") de forma r√°pida e eficiente, usando o servi√ßo de Gists do GitHub como sua plataforma de nuvem.</p>
                        
                        <h3>Principais Funcionalidades</h3>
                        <ul>
                            <li><strong>üì§ Upload R√°pido de Arquivos</strong><br>
                            Selecione qualquer arquivo `.txt` e envie-o com um √∫nico comando para o GitHub Gist.</li>
                            
                            <li><strong>üîó Gera√ß√£o Autom√°tica de URLs Curtas</strong><br>
                            Ap√≥s cada upload, o script gera e exibe 2 tipos de URLs: a da p√°gina do Gist, a URL Raw Curta (para scripts) e uma URL super curta do TinyURL.</li>
                            
                            <li><strong>üìÇ Download e Backup Flex√≠vel</strong><br>
                            Oferece um menu de download com tr√™s modos: baixar um Gist espec√≠fico, baixar todos em arquivos separados ou baixar todos em um √∫nico arquivo de backup.</li>
                            
                            <li><strong>üóëÔ∏è Gerenciamento e Exclus√£o de Gists</strong><br>
                            Liste todos os seus Gists e escolha qual deles deseja excluir permanentemente, com uma confirma√ß√£o de seguran√ßa.</li>
                            
                            <li><strong>üìù Arquivo Texto Salvo</strong><br>
                            Cada upload √© registrado em um arquivo com um formato limpo, incluindo data, hora, nome do arquivo e as URLs geradas.</li>
                            
                            <li><strong>üîë Armazenamento Seguro de Token</strong><br>
                            Para sua conveni√™ncia, o script salva seu Token de Acesso do GitHub no localStorage do navegador. Voc√™ s√≥ precisa inseri-lo uma vez.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Guia de Instala√ß√£o -->
    <div class="modal fade" id="installModal" tabindex="-1" aria-labelledby="installModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="installModalLabel">Guia de Instala√ß√£o e Primeiro Uso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="guide-content">
                        <h3>Passo 1: Como Gerar seu GitHub Token</h3>
                        <ol>
                            <li>Fa√ßa um cadastro no site <a href="https://github.com" target="_blank">https://github.com</a>. Depois de criar a conta, acesse a p√°gina de tokens do GitHub: <a href="https://github.com/settings/tokens" target="_blank">https://github.com/settings/tokens</a></li>
                            <li>Clique em <strong>Generate new token</strong> e depois em <strong>Generate new token (classic)</strong>.</li>
                            <li>Preencha as informa√ß√µes do token:
                                <ul>
                                    <li><strong>Note (Nota):</strong> D√™ um nome que voc√™ reconhe√ßa, como `Token Script Ghost`.</li>
                                    <li><strong>Expiration (Validade):</strong> Escolha `No expiration` (Sem validade).</li>
                                    <li><strong>Select scopes (Selecionar escopos):</strong> Esta √© a parte mais importante. Marque APENAS a caixa de sele√ß√£o ao lado de <code>gist</code>.</li>
                                </ul>
                            </li>
                            <li>Gere e copie o token:
                                <ul>
                                    <li>Clique no bot√£o verde <strong>Generate token</strong>.</li>
                                    <li><strong>ATEN√á√ÉO:</strong> O GitHub mostrar√° seu token (come√ßa com `ghp_...`). Copie-o imediatamente.</li>
                                </ul>
                            </li>
                        </ol>
                        
                        <h3>Passo 2: Usando o Script</h3>
                        <ol>
                            <li>Acesse esta aplica√ß√£o web no seu navegador.</li>
                            <li>Na primeira vez, ele pedir√° o token. Cole o token que voc√™ copiou do GitHub e pressione Enter.</li>
                        </ol>
                        
                        <h3>Como o Token √© Salvo</h3>
                        <p>Ap√≥s colar seu token, o script o salvar√° no localStorage do seu navegador.</p>
                        <ul>
                            <li>Gra√ßas a este recurso, voc√™ n√£o precisar√° digitar o token novamente.</li>
                            <li>Se voc√™ precisar usar um novo token no futuro, simplesmente limpe os dados do site no seu navegador ou use a nova op√ß√£o "Gerenciar Token".</li>
                        </ul>
                        
                        <p><strong>Pronto!</strong> Agora voc√™ pode usar todas as funcionalidades do script.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notifica√ß√£o -->
    <div class="notification" id="notification">
        <i class="fas fa-info-circle"></i>
        <span id="notificationText"></span>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Vari√°veis globais
        let githubToken = localStorage.getItem('githubToken') || '';
        let gistsList = [];
        let selectedFile = null;
        let deferredPrompt;
        
        // Elementos do DOM
        const uploadBtn = document.getElementById('uploadBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const guideBtn = document.getElementById('guideBtn');
        const installBtn = document.getElementById('installBtn');
        const manageTokenBtn = document.getElementById('manageTokenBtn');
        // NOVO ELEMENTO
        const installAppBtn = document.getElementById('installAppBtn');
        
        const uploadSection = document.getElementById('uploadSection');
        const deleteSection = document.getElementById('deleteSection');
        const downloadSection = document.getElementById('downloadSection');
        
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const processUploadBtn = document.getElementById('processUploadBtn');
        const cancelUploadBtn = document.getElementById('cancelUploadBtn');
        
        const gistsListDelete = document.getElementById('gistsListDelete');
        const refreshDeleteBtn = document.getElementById('refreshDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        
        const gistsListDownload = document.getElementById('gistsListDownload');
        const refreshDownloadBtn = document.getElementById('refreshDownloadBtn');
        const cancelDownloadBtn = document.getElementById('cancelDownloadBtn');
        const downloadSingleBtn = document.getElementById('downloadSingleBtn');
        const downloadSeparateBtn = document.getElementById('downloadSeparateBtn');
        const downloadCombinedBtn = document.getElementById('downloadCombinedBtn');
        
        const tokenModal = new bootstrap.Modal(document.getElementById('tokenModal'));
        const guideModal = new bootstrap.Modal(document.getElementById('guideModal'));
        const installModal = new bootstrap.Modal(document.getElementById('installModal'));
        
        const githubTokenInput = document.getElementById('githubToken');
        const saveTokenCheckbox = document.getElementById('saveToken');
        const saveTokenBtn = document.getElementById('saveTokenBtn');
        
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');
        
        // Elementos PWA
        const installBanner = document.getElementById('installBanner');
        const installPwaBtn = document.getElementById('installPwaBtn');
        const dismissInstallBtn = document.getElementById('dismissInstallBtn');
        
        // Event Listeners
        uploadBtn.addEventListener('click', () => {
            hideAllSections();
            uploadSection.classList.remove('hidden');
        });
        
        deleteBtn.addEventListener('click', () => {
            if (!githubToken) {
                tokenModal.show();
                return;
            }
            hideAllSections();
            deleteSection.classList.remove('hidden');
            loadGistsForDelete();
        });
        
        downloadBtn.addEventListener('click', () => {
            if (!githubToken) {
                tokenModal.show();
                return;
            }
            hideAllSections();
            downloadSection.classList.remove('hidden');
            loadGistsForDownload();
        });
        
        guideBtn.addEventListener('click', () => {
            guideModal.show();
        });
        
        installBtn.addEventListener('click', () => {
            installModal.show();
        });
        
        manageTokenBtn.addEventListener('click', manageToken);

        // NOVO EVENT LISTENER PARA O BOT√ÉO DE INSTALA√á√ÉO MANUAL
        installAppBtn.addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showNotification('Aplicativo instalado com sucesso!', 'success');
                    } else {
                        showNotification('Instala√ß√£o cancelada.', 'warning');
                    }
                    deferredPrompt = null;
                    // Esconder o bot√£o ap√≥s a intera√ß√£o
                    installAppBtn.classList.add('hidden');
                });
            } else {
                showNotification('A instala√ß√£o n√£o est√° dispon√≠vel no momento. Verifique se o site est√° servido via HTTPS.', 'warning');
            }
        });

        cancelUploadBtn.addEventListener('click', () => {
            hideAllSections();
            selectedFile = null;
            fileInfo.innerHTML = '';
        });
        
        cancelDeleteBtn.addEventListener('click', () => {
            hideAllSections();
        });
        
        cancelDownloadBtn.addEventListener('click', () => {
            hideAllSections();
        });
        
        fileUploadArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });
        
        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });
        
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });
        
        processUploadBtn.addEventListener('click', () => {
            if (!selectedFile) {
                showNotification('Selecione um arquivo primeiro', 'error');
                return;
            }
            
            if (!githubToken) {
                tokenModal.show();
                return;
            }
            
            uploadFile();
        });
        
        refreshDeleteBtn.addEventListener('click', () => {
            loadGistsForDelete();
        });
        
        refreshDownloadBtn.addEventListener('click', () => {
            loadGistsForDownload();
        });
        
        downloadSingleBtn.addEventListener('click', () => {
            if (gistsList.length === 0) {
                showNotification('Nenhum Gist dispon√≠vel para download', 'warning');
                return;
            }
            
            downloadGist(gistsList[0]);
        });
        
        downloadSeparateBtn.addEventListener('click', () => {
            if (gistsList.length === 0) {
                showNotification('Nenhum Gist dispon√≠vel para download', 'warning');
                return;
            }
            
            gistsList.forEach(gist => {
                downloadGist(gist);
            });
            
            showNotification(`Download de ${gistsList.length} Gists iniciado`, 'success');
        });
        
        downloadCombinedBtn.addEventListener('click', () => {
            if (gistsList.length === 0) {
                showNotification('Nenhum Gist dispon√≠vel para download', 'warning');
                return;
            }
            
            downloadAllGistsCombined();
        });
        
        saveTokenBtn.addEventListener('click', () => {
            const token = githubTokenInput.value.trim();
            if (!token) {
                showNotification('Token n√£o pode ser vazio', 'error');
                return;
            }
            
            if (saveTokenCheckbox.checked) {
                localStorage.setItem('githubToken', token);
            }
            
            githubToken = token;
            tokenModal.hide();
            showNotification('Token salvo com sucesso', 'success');
        });
        
        // Eventos PWA
        installPwaBtn.addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showNotification('Aplicativo instalado com sucesso!', 'success');
                    }
                    deferredPrompt = null;
                });
            }
        });
        
        dismissInstallBtn.addEventListener('click', () => {
            installBanner.classList.remove('show');
            // N√£o salvamos mais no localStorage para permitir testes
        });
        
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration);
                    })
                    .catch(error => {
                        console.log('Falha ao registrar Service Worker:', error);
                    });
            });
        }
        
        // Evento para instala√ß√£o do PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar o bot√£o de instala√ß√£o no menu
            installAppBtn.classList.remove('hidden');

            // Mostrar banner de instala√ß√£o ap√≥s um pequeno delay
            setTimeout(() => {
                installBanner.classList.add('show');
            }, 3000);
        });
        
        // Evento quando o PWA √© instalado com sucesso
        window.addEventListener('appinstalled', () => {
            showNotification('Aplicativo instalado com sucesso!', 'success');
            installBanner.classList.remove('show');
            installAppBtn.classList.add('hidden'); // Esconder o bot√£o
            deferredPrompt = null;
        });
        
        // Fun√ß√µes
        function hideAllSections() {
            uploadSection.classList.add('hidden');
            deleteSection.classList.add('hidden');
            downloadSection.classList.add('hidden');
        }
        
        function handleFileSelect(file) {
            if (!file.name.match(/\.(txt)$/i)) {
                showNotification('Por favor, selecione um arquivo .txt', 'error');
                return;
            }
            
            selectedFile = file;
            fileInfo.innerHTML = `
                <div class="alert alert-info">
                    <strong>Arquivo:</strong> ${file.name}<br>
                    <strong>Tamanho:</strong> ${formatFileSize(file.size)}
                </div>
            `;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        async function uploadFile() {
            if (!selectedFile || !githubToken) return;
            
            processUploadBtn.disabled = true;
            processUploadBtn.innerHTML = '<span class="loading-spinner"></span> Enviando...';
            
            try {
                const content = await readFileContent(selectedFile);
                
                const payload = {
                    description: `Arquivo original: ${selectedFile.name}`,
                    public: true,
                    files: {
                        "upload.txt": {
                            content: content
                        }
                    }
                };
                
                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.status === 201) {
                    const data = await response.json();
                    const gistId = data.id;
                    const ownerLogin = data.owner.login;
                    const shortRawUrl = `https://gist.githubusercontent.com/${ownerLogin}/${gistId}/raw/`;
                    
                    let tinyUrl = '';
                    try {
                        const tinyResponse = await fetch(`http://tinyurl.com/api-create.php?url=${encodeURIComponent(shortRawUrl)}`);
                        if (tinyResponse.status === 200) {
                            tinyUrl = await tinyResponse.text();
                        }
                    } catch (error) {
                        console.error('Erro ao gerar TinyURL:', error);
                    }
                    
                    const timestamp = new Date().toLocaleString();
                    const logEntry = {
                        timestamp,
                        fileName: selectedFile.name,
                        rawUrl: shortRawUrl,
                        tinyUrl
                    };
                    
                    let savedUrls = JSON.parse(localStorage.getItem('gistUrls') || '[]');
                    savedUrls.push(logEntry);
                    localStorage.setItem('gistUrls', JSON.stringify(savedUrls));
                    
                    fileInfo.innerHTML += `
                        <div class="alert alert-success mt-3">
                            <strong>‚úÖ Arquivo enviado com sucesso!</strong><br>
                            üîó URL Raw: <a href="${shortRawUrl}" target="_blank">${shortRawUrl}</a><br>
                            ${tinyUrl ? `ü§è URL TinyURL: <a href="${tinyUrl}" target="_blank">${tinyUrl}</a>` : ''}
                        </div>
                    `;
                    
                    showNotification('Arquivo enviado com sucesso!', 'success');
                } else {
                    const errorData = await response.json();
                    showNotification(`Erro ao enviar arquivo: ${errorData.message}`, 'error');
                }
            } catch (error) {
                showNotification(`Erro de conex√£o: ${error.message}`, 'error');
            } finally {
                processUploadBtn.disabled = false;
                processUploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Enviar para Gist';
            }
        }
        
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => resolve(event.target.result);
                reader.onerror = (error) => reject(error);
                reader.readAsText(file);
            });
        }
        
        async function loadGistsForDelete() {
            gistsListDelete.innerHTML = '<p class="text-center"><span class="loading-spinner"></span> Carregando seus Gists...</p>';
            
            try {
                const response = await fetch('https://api.github.com/gists', {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.status === 200) {
                    gistsList = await response.json();
                    
                    if (gistsList.length === 0) {
                        gistsListDelete.innerHTML = '<p class="text-center">Nenhum Gist encontrado.</p>';
                        return;
                    }
                    
                    let html = '';
                    gistsList.forEach((gist, index) => {
                        const description = gist.description || 'Sem descri√ß√£o';
                        html += `
                            <div class="gist-item">
                                <div class="gist-description">${description}</div>
                                <div class="gist-url">${gist.html_url}</div>
                                <div class="text-end">
                                    <button class="action-btn delete" onclick="deleteGist('${gist.id}', '${description}')">
                                        <i class="fas fa-trash-alt"></i> Excluir
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    gistsListDelete.innerHTML = html;
                } else {
                    gistsListDelete.innerHTML = `<p class="text-center text-danger">Erro ao carregar Gists: ${response.status}</p>`;
                }
            } catch (error) {
                gistsListDelete.innerHTML = `<p class="text-center text-danger">Erro de conex√£o: ${error.message}</p>`;
            }
        }
        
        async function loadGistsForDownload() {
            gistsListDownload.innerHTML = '<p class="text-center"><span class="loading-spinner"></span> Carregando seus Gists...</p>';
            
            try {
                const response = await fetch('https://api.github.com/gists', {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.status === 200) {
                    gistsList = await response.json();
                    
                    if (gistsList.length === 0) {
                        gistsListDownload.innerHTML = '<p class="text-center">Nenhum Gist encontrado.</p>';
                        return;
                    }
                    
                    let html = '';
                    gistsList.forEach((gist, index) => {
                        const description = gist.description || 'Sem descri√ß√£o';
                        const fileName = Object.keys(gist.files)[0] || 'arquivo';
                        html += `
                            <div class="gist-item">
                                <div class="gist-description">${description}</div>
                                <div class="gist-url">${gist.html_url}</div>
                                <div class="text-end">
                                    <button class="action-btn download" onclick="downloadGist(${index})">
                                        <i class="fas fa-download"></i> Baixar
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    gistsListDownload.innerHTML = html;
                } else {
                    gistsListDownload.innerHTML = `<p class="text-center text-danger">Erro ao carregar Gists: ${response.status}</p>`;
                }
            } catch (error) {
                gistsListDownload.innerHTML = `<p class="text-center text-danger">Erro de conex√£o: ${error.message}</p>`;
            }
        }
        
        async function deleteGist(gistId, description) {
            if (!confirm(`Tem certeza que deseja excluir "${description}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.status === 204) {
                    showNotification('Gist exclu√≠do com sucesso!', 'success');
                    loadGistsForDelete();
                } else {
                    showNotification(`Erro ao excluir Gist: ${response.status}`, 'error');
                }
            } catch (error) {
                showNotification(`Erro de conex√£o: ${error.message}`, 'error');
            }
        }
        
        async function downloadGist(gist) {
            const gistObj = typeof gist === 'number' ? gistsList[gist] : gist;
            const fileName = Object.keys(gistObj.files)[0] || 'arquivo';
            const rawUrl = gistObj.files[fileName].raw_url;
            
            try {
                const response = await fetch(rawUrl);
                if (response.status === 200) {
                    const content = await response.text();
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showNotification(`Gist "${fileName}" baixado com sucesso!`, 'success');
                } else {
                    showNotification(`Erro ao baixar Gist: ${response.status}`, 'error');
                }
            } catch (error) {
                showNotification(`Erro de conex√£o: ${error.message}`, 'error');
            }
        }
        
        async function downloadAllGistsCombined() {
            let combinedContent = '';
            const timestamp = new Date().toISOString().split('T')[0];
            
            for (const gist of gistsList) {
                const fileName = Object.keys(gist.files)[0] || 'arquivo';
                const rawUrl = gist.files[fileName].raw_url;
                
                try {
                    const response = await fetch(rawUrl);
                    if (response.status === 200) {
                        const content = await response.text();
                        combinedContent += `=============================================\n`;
                        combinedContent += `Arquivo: ${fileName}\n`;
                        combinedContent += `URL: ${gist.html_url}\n`;
                        combinedContent += `=============================================\n\n`;
                        combinedContent += `${content}\n\n\n`;
                    }
                } catch (error) {
                    console.error(`Erro ao baixar Gist ${fileName}:`, error);
                }
            }
            
            if (combinedContent) {
                const blob = new Blob([combinedContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gist-backup-${timestamp}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('Backup combinado baixado com sucesso!', 'success');
            } else {
                showNotification('N√£o foi poss√≠vel baixar o conte√∫do dos Gists', 'error');
            }
        }
        
        function showNotification(message, type = 'info') {
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            notification.className = `notification ${type} show`;
            notification.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span>`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        function manageToken() {
            if (githubToken) {
                if (confirm('Um token j√° est√° salvo. Deseja remov√™-lo?')) {
                    localStorage.removeItem('githubToken');
                    githubToken = '';
                    showNotification('Token removido com sucesso!', 'success');
                }
            } else {
                tokenModal.show();
            }
        }
        
        // Verificar se h√° token salvo ao carregar a p√°gina
        window.addEventListener('load', () => {
            if (githubToken) {
                showNotification('Token do GitHub carregado do localStorage', 'success');
            }
        });
    </script>
</body>
</html>